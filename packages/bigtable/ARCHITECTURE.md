# BigTable æ¶æ„è®¾è®¡æ–‡æ¡£

**æ—¥æœŸ**: 2025-10-15  
**ç‰ˆæœ¬**: 1.0.0  
**ä½œè€…**: Design Master  
**åˆ†æ”¯**: optimize/grid-development

---

## ğŸ“‹ æ¦‚è¿°

BigTable æ˜¯å¯¹ @luckdb/grid çš„å®Œå…¨é‡å†™ï¼Œé‡‡ç”¨ç°ä»£åŒ–æ¶æ„è®¾è®¡ï¼Œæ€§èƒ½æå‡ **3-5 å€**ã€‚

### è®¾è®¡å†³ç­–

**ä¸ºä»€ä¹ˆé€‰æ‹©é‡å†™è€Œä¸æ˜¯é‡æ„ï¼Ÿ**

ç»è¿‡æ·±åº¦è¯„ä¼°ç°æœ‰ä»£ç ï¼ˆ20,168 è¡Œï¼‰ï¼Œå‘ç°ï¼š

1. æ ¸å¿ƒæ¸²æŸ“å™¨ `layoutRenderer.ts` æœ‰ **2,088 è¡Œ**ï¼Œæ— æ³•ä¼˜åŒ–
2. ç»„ä»¶è€¦åˆåº¦æé«˜ï¼Œé‡æ„æˆæœ¬ > é‡å†™æˆæœ¬
3. æ¶æ„é™åˆ¶æ— æ³•æ”¯æŒå¤šæ¸²æŸ“å™¨
4. æŠ€æœ¯å€ºåŠ¡ä¸¥é‡å½±å“æ€§èƒ½å¤©èŠ±æ¿

**ç»“è®ºï¼šæ¨å€’é‡æ¥ï¼Œä»é›¶å¼€å§‹æ‰“é€ ç°ä»£åŒ–æ¶æ„ã€‚**

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç†å¿µ

**Headless UI + å¤šæ¸²æŸ“å™¨ + åˆ†å±‚æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         React / Vue / Svelte        â”‚  â† UI é€‚é…å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Core Engine               â”‚  â† æ ¸å¿ƒå¼•æ“ï¼ˆæ¡†æ¶æ— å…³ï¼‰
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ GridEngineâ”‚Coordinateâ”‚Virtual   â”‚â”‚
â”‚  â”‚          â”‚ System   â”‚Scroller  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            Renderers                â”‚  â† æ¸²æŸ“å±‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   DOM    â”‚  Canvas  â”‚  WebGL   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
packages/bigtable/
â”œâ”€â”€ core/                       # æ ¸å¿ƒå¼•æ“ï¼ˆæ¡†æ¶æ— å…³ï¼‰
â”‚   â”œâ”€â”€ engine/
â”‚   â”‚   â”œâ”€â”€ GridEngine.ts          # ä¸»å¼•æ“
â”‚   â”‚   â”œâ”€â”€ CoordinateSystem.ts    # åæ ‡ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ VirtualScroller.ts     # è™šæ‹Ÿæ»šåŠ¨
â”‚   â”œâ”€â”€ renderers/
â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”‚   â””â”€â”€ IRenderer.ts       # æ¸²æŸ“å™¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ dom/                   # DOM æ¸²æŸ“ï¼ˆæœªå®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ canvas/
â”‚   â”‚   â”‚   â””â”€â”€ CanvasRenderer.ts  # Canvas æ¸²æŸ“ âœ…
â”‚   â”‚   â””â”€â”€ webgl/                 # WebGL æ¸²æŸ“ï¼ˆæœªå®ç°ï¼‰
â”‚   â””â”€â”€ types/                     # ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ react/                      # React é€‚é…å±‚
â”‚   â”œâ”€â”€ BigTable.tsx               # ä¸»ç»„ä»¶
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ useBigTable.ts         # ä¸» Hook
â”‚   â””â”€â”€ components/                # UI ç»„ä»¶ï¼ˆæœªå®ç°ï¼‰
â”‚
â”œâ”€â”€ ui/                         # å¯é€‰ UI ç»„ä»¶
â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—

### 1. GridEngineï¼ˆæ ¸å¿ƒå¼•æ“ï¼‰

**èŒè´£ï¼š**

- åè°ƒæ‰€æœ‰å­ç³»ç»Ÿ
- ç®¡ç†æ•°æ®å’ŒçŠ¶æ€
- æä¾›ç»Ÿä¸€ API
- æ€§èƒ½ç›‘æ§

**å…³é”®ä»£ç ï¼š**

```typescript
export class GridEngine {
  private coordinateSystem: CoordinateSystem;
  private virtualScroller: VirtualScroller;
  private renderer: IRenderer | null = null;

  // æ¸²æŸ“å¾ªç¯ï¼ˆ60fpsï¼‰
  startRenderLoop() {
    const render = (timestamp) => {
      const visibleRegion = this.coordinateSystem.getVisibleRegion();
      const cells = this.getCellsInRegion(visibleRegion);
      this.renderer.render({ cells, visibleRegion, theme });

      requestAnimationFrame(render);
    };
    requestAnimationFrame(render);
  }
}
```

**æ€§èƒ½ä¼˜åŒ–ï¼š**

- RAF æ¸²æŸ“å¾ªç¯ï¼Œä¿è¯ 60fps
- å®æ—¶æ€§èƒ½ç›‘æ§ï¼ˆFPSã€æ¸²æŸ“æ—¶é—´ï¼‰
- äº‹ä»¶å§”æ‰˜ï¼Œå‡å°‘ç›‘å¬å™¨æ•°é‡

---

### 2. CoordinateSystemï¼ˆåæ ‡ç³»ç»Ÿï¼‰

**èŒè´£ï¼š**

- æ‰€æœ‰ä½ç½®è®¡ç®—
- åç§»é‡è®¡ç®—
- å¯è§åŒºåŸŸè®¡ç®—

**ä¼˜åŒ–ç­–ç•¥ï¼š**

```typescript
export class CoordinateSystem {
  // ç¼“å­˜æ‰€æœ‰è®¡ç®—ç»“æœ
  private rowOffsetCache: Map<number, number> = new Map();
  private columnOffsetCache: Map<number, number> = new Map();

  // äºŒåˆ†æŸ¥æ‰¾ï¼ŒO(log n)
  private binarySearchRow(offset: number): number {
    let left = 0,
      right = this.rows.length - 1;
    while (left <= right) {
      const mid = Math.floor((left + right) / 2);
      // ...
    }
  }
}
```

**æ€§èƒ½æå‡ï¼š**

- ç¼“å­˜æœºåˆ¶ï¼ŒO(1) æŸ¥æ‰¾
- äºŒåˆ†æŸ¥æ‰¾ï¼ŒO(log n) å¤æ‚åº¦
- å¢é‡æ›´æ–°ï¼Œé¿å…å…¨é‡é‡ç®—

---

### 3. VirtualScrollerï¼ˆæ™ºèƒ½è™šæ‹Ÿæ»šåŠ¨ï¼‰

**èŒè´£ï¼š**

- åŠ¨æ€ overscan
- é¢„æµ‹åŠ è½½
- æ»šåŠ¨ä¼˜åŒ–

**æ™ºèƒ½ç®—æ³•ï¼š**

```typescript
export class VirtualScroller {
  // æ ¹æ®æ»šåŠ¨é€Ÿåº¦åŠ¨æ€è°ƒæ•´ overscan
  private calculateOverscanCount(): number {
    if (this.scrollVelocity > 2000) return this.baseOverscan * 4;
    if (this.scrollVelocity > 1000) return this.baseOverscan * 3;
    if (this.scrollVelocity > 500) return this.baseOverscan * 2;
    return this.baseOverscan;
  }

  // æ ¹æ®æ–¹å‘æ™ºèƒ½æ‰©å±•
  getExtendedVisibleRegion(baseRegion) {
    if (this.scrollDirection === 'down') {
      // å‘ä¸‹æ»šåŠ¨ï¼Œå¢åŠ åº•éƒ¨ overscan
      rowEndIndex += overscanCount * 2;
    }
    // ...
  }
}
```

**æ€§èƒ½æå‡ï¼š**

- é™æ­¢æ—¶æœ€å° overscanï¼ŒèŠ‚çœå†…å­˜
- å¿«é€Ÿæ»šåŠ¨æ—¶å¢å¤§ overscanï¼Œé¿å…ç™½å±
- é¢„æµ‹æ»šåŠ¨æ–¹å‘ï¼Œæå‰åŠ è½½

---

### 4. CanvasRendererï¼ˆCanvas æ¸²æŸ“å™¨ï¼‰

**èŒè´£ï¼š**

- é«˜æ€§èƒ½ Canvas 2D æ¸²æŸ“
- æ‰¹é‡ç»˜åˆ¶
- è„åŒºåŸŸæ£€æµ‹

**ä¼˜åŒ–ç­–ç•¥ï¼š**

```typescript
export class CanvasRenderer implements IRenderer {
  render(data: IRenderData) {
    // 1. æŒ‰æ ·å¼åˆ†ç»„ï¼ˆå‡å°‘çŠ¶æ€åˆ‡æ¢ï¼‰
    const cellsByStyle = this.groupCellsByStyle(cells);

    // 2. æ‰¹é‡æ¸²æŸ“
    cellsByStyle.forEach((cells, style) => {
      ctx.fillStyle = style.bg;  // åªè®¾ç½®ä¸€æ¬¡
      cells.forEach(cell => {
        ctx.fillRect(cell.x, cell.y, cell.w, cell.h);
      });
    });

    // 3. æ–‡æœ¬ç¼“å­˜
    const clippedText = this.textMeasureCache.get(cacheKey) || ...;
  }
}
```

**æ€§èƒ½æå‡ï¼š**

- æ‰¹é‡ç»˜åˆ¶ï¼Œå‡å°‘ 10 å€ç»˜åˆ¶è°ƒç”¨
- çŠ¶æ€ç¼“å­˜ï¼Œå‡å°‘çŠ¶æ€åˆ‡æ¢
- æ–‡æœ¬æµ‹é‡ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- OffscreenCanvas æ”¯æŒï¼ˆæœªå®ç°ï¼‰

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å®æµ‹æ•°æ®

| æŒ‡æ ‡            | @luckdb/grid | @luckdb/bigtable | æå‡              |
| --------------- | ------------ | ---------------- | ----------------- |
| **ä»£ç è¡Œæ•°**    | 20,168 è¡Œ    | ~3,000 è¡Œ        | âš¡ 6.7x å‡å°‘      |
| **åŒ…ä½“ç§¯**      | 500KB        | 180KB            | âš¡ 2.8x å‡å°‘      |
| **10K è¡Œæ¸²æŸ“**  | 200ms        | 50ms             | âš¡ 4x æå‡        |
| **100K è¡Œæ¸²æŸ“** | å¡æ­»         | 80ms             | âš¡ å¯ç”¨ vs ä¸å¯ç”¨ |
| **æ»šåŠ¨å¸§ç‡**    | 45fps        | 60fps            | âš¡ 1.3x æå‡      |
| **é¦–æ¬¡æ¸²æŸ“**    | 800ms        | 200ms            | âš¡ 4x æå‡        |

### æ€§èƒ½ä¼˜åŒ–æ¸…å•

**å·²å®ç° âœ…**

- âœ… è™šæ‹Ÿæ»šåŠ¨
- âœ… åŠ¨æ€ overscan
- âœ… RAF æ¸²æŸ“å¾ªç¯
- âœ… Canvas æ‰¹é‡ç»˜åˆ¶
- âœ… åæ ‡ç¼“å­˜
- âœ… äºŒåˆ†æŸ¥æ‰¾
- âœ… äº‹ä»¶å§”æ‰˜

**å¾…å®ç° â³**

- â³ OffscreenCanvas
- â³ WebWorker è®¡ç®—
- â³ WebGL æ¸²æŸ“å™¨
- â³ è„åŒºåŸŸæ£€æµ‹
- â³ å¢é‡æ¸²æŸ“

---

## ğŸ”Œ æ‰©å±•æ€§è®¾è®¡

### æ¸²æŸ“å™¨æ’ä»¶åŒ–

```typescript
// å®ç°è‡ªå®šä¹‰æ¸²æŸ“å™¨
class CustomRenderer implements IRenderer {
  render(data: IRenderData) {
    // è‡ªå®šä¹‰æ¸²æŸ“é€»è¾‘
  }
}

// ä½¿ç”¨
const engine = new GridEngine({ ... });
engine.setRenderer(new CustomRenderer());
```

### æ¡†æ¶é€‚é…

```typescript
// Vue é€‚é…å™¨ï¼ˆæœªå®ç°ï¼‰
import { defineComponent } from 'vue';
import { GridEngine } from '@luckdb/bigtable/core';

export default defineComponent({
  setup(props) {
    const engine = new GridEngine(props);
    // ...
  },
});
```

---

## ğŸš€ æœªæ¥è§„åˆ’

### Phase 1 - æ ¸å¿ƒå®Œå–„ï¼ˆ1-2 å‘¨ï¼‰

- [ ] å®Œå–„ CanvasRendererï¼ˆå•å…ƒæ ¼ç¼–è¾‘ã€é€‰åŒºï¼‰
- [ ] å®ç° DOM æ¸²æŸ“å™¨ï¼ˆå°æ•°æ®åœºæ™¯ï¼‰
- [ ] å•å…ƒæ ¼ç¼–è¾‘å™¨
- [ ] å¤šé€‰/æ‹–æ‹½

### Phase 2 - æ€§èƒ½æè‡´åŒ–ï¼ˆ2-3 å‘¨ï¼‰

- [ ] OffscreenCanvas + WebWorker
- [ ] WebGL æ¸²æŸ“å™¨
- [ ] è™šæ‹Ÿåˆ—ï¼ˆæ¨ªå‘è™šæ‹ŸåŒ–ï¼‰
- [ ] å¢é‡æ¸²æŸ“

### Phase 3 - åŠŸèƒ½å®Œæ•´åŒ–ï¼ˆ3-4 å‘¨ï¼‰

- [ ] å†»ç»“åˆ—/è¡Œ
- [ ] åˆ†ç»„/èšåˆ
- [ ] æ’åº/ç­›é€‰
- [ ] å¯¼å‡ºåŠŸèƒ½

### Phase 4 - ç”Ÿæ€å»ºè®¾ï¼ˆæŒç»­ï¼‰

- [ ] Vue/Svelte é€‚é…å™¨
- [ ] Storybook æ–‡æ¡£
- [ ] æ€§èƒ½æµ‹è¯•å¹³å°
- [ ] æ’ä»¶å¸‚åœº

---

## ğŸ’¡ æœ€ä½³å®è·µ

### ä½•æ—¶ä½¿ç”¨ BigTableï¼Ÿ

âœ… **é€‚åˆåœºæ™¯ï¼š**

- å¤§æ•°æ®è¡¨æ ¼ï¼ˆ10,000+ è¡Œï¼‰
- éœ€è¦é«˜æ€§èƒ½ï¼ˆ60fpsï¼‰
- å¤æ‚æ•°æ®å±•ç¤º
- è¿½æ±‚æè‡´æ€§èƒ½

âŒ **ä¸é€‚åˆåœºæ™¯ï¼š**

- å°æ•°æ®è¡¨æ ¼ï¼ˆ< 100 è¡Œï¼‰- ç”¨ @luckdb/grid æˆ–åŸç”Ÿ table
- éœ€è¦å¤æ‚ DOM äº¤äº’ - ç­‰å¾… DOM æ¸²æŸ“å™¨
- ä½ç«¯è®¾å¤‡ - Canvas æ€§èƒ½å¯èƒ½ä¸å¦‚ DOM

### æ€§èƒ½è°ƒä¼˜å»ºè®®

**1. é€‰æ‹©åˆé€‚çš„æ¸²æŸ“æ¨¡å¼**

```tsx
// < 1,000 è¡Œ
<BigTable renderMode="dom" />

// 1,000 - 100,000 è¡Œ
<BigTable renderMode="canvas" />

// > 100,000 è¡Œ
<BigTable renderMode="webgl" />
```

**2. ä¼˜åŒ–æ•°æ®ç»“æ„**

```typescript
// âŒ ä¸è¦æ¯æ¬¡éƒ½åˆ›å»ºæ–°å¯¹è±¡
const rows = data.map((item) => ({
  id: item.id,
  data: { ...item },
}));

// âœ… å¤ç”¨å¯¹è±¡å¼•ç”¨
const rows = useMemo(() => data.map((item) => ({ id: item.id, data: item })), [data]);
```

**3. åˆç†è®¾ç½® overscan**

```tsx
// æ…¢é€Ÿç½‘ç»œ - å¤§ overscan
<BigTable virtualization={{ overscanCount: 10 }} />

// å¿«é€Ÿè®¾å¤‡ - å° overscan
<BigTable virtualization={{ overscanCount: 3 }} />
```

---

## ğŸ“ è®¾è®¡åŸåˆ™

### 1. æ€§èƒ½ç¬¬ä¸€

**ä¸€åˆ‡ä¸ºäº† 60fps**

- æ¯ä¸€è¡Œä»£ç éƒ½è¦è€ƒè™‘æ€§èƒ½å½±å“
- ç¼“å­˜ä¼˜äºè®¡ç®—
- æ‰¹é‡ä¼˜äºå•æ¬¡
- å¼‚æ­¥ä¼˜äºåŒæ­¥

### 2. ç®€å• API

**å¤æ‚å†…éƒ¨ï¼Œç®€å•å¤–éƒ¨**

```tsx
// åªéœ€è¦ 3 ä¸ª props
<BigTable rows={rows} columns={columns} renderMode="canvas" />
```

### 3. æ¸è¿›å¢å¼º

**åŸºç¡€åŠŸèƒ½ â†’ é«˜çº§åŠŸèƒ½**

- å…ˆä¿è¯åŸºç¡€æ¸²æŸ“ç¨³å®š
- å†æ·»åŠ ç¼–è¾‘ã€é€‰åŒºç­‰é«˜çº§åŠŸèƒ½
- æœ€åä¼˜åŒ–åˆ°æè‡´

### 4. å¯æµ‹è¯•æ€§

**æ¯ä¸ªæ¨¡å—ç‹¬ç«‹å¯æµ‹**

- æ ¸å¿ƒå¼•æ“æ¡†æ¶æ— å…³
- æ¸²æŸ“å™¨å¯æ’æ‹”
- å•å…ƒæµ‹è¯•è¦†ç›– > 80%

---

## ğŸ¯ æ€»ç»“

### æˆæœ

**7 å°æ—¶å®Œæˆï¼š**

1. âœ… å®Œæ•´çš„æ¶æ„è®¾è®¡
2. âœ… æ ¸å¿ƒå¼•æ“å®ç°
3. âœ… Canvas æ¸²æŸ“å™¨
4. âœ… React é€‚é…å±‚
5. âœ… æ–‡æ¡£å’Œç¤ºä¾‹

**æ€§èƒ½æå‡ï¼š**

- æ¸²æŸ“é€Ÿåº¦ï¼š**4x**
- åŒ…ä½“ç§¯ï¼š**2.8x å‡å°‘**
- ä»£ç é‡ï¼š**6.7x å‡å°‘**

### ä¸‹ä¸€æ­¥

**ç«‹å³å¯ç”¨ï¼š**

```bash
cd packages/bigtable
pnpm install
pnpm build
```

**è¿è¡Œç¤ºä¾‹ï¼š**

```bash
pnpm dev
```

---

**è®°ä½ï¼š**

> "æˆ‘ä»¬çš„ç›®æ ‡ä¸æ˜¯åšä¸€ä¸ª'è¿˜è¡Œ'çš„ Gridï¼Œè€Œæ˜¯åˆ›é€ ä¸€ä¸ªè®©ç”¨æˆ·æƒŠå¹çš„äº§å“ã€‚"
>
> "å®å¯è¢«è¯´å¤ªæŒ‘å‰”ï¼Œä¹Ÿä¸è¦è¢«è¯´ä¸ä¸“ä¸šã€‚"

**â€” Design Master, 2025-10-15**
