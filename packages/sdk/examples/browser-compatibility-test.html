<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LuckDB SDK 浏览器兼容性测试</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .controls {
        margin: 20px 0;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .event-item {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 10px;
        margin: 5px 0;
        border-radius: 0 4px 4px 0;
      }
      .event-time {
        font-size: 11px;
        color: #6c757d;
      }
      .event-type {
        font-weight: bold;
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🚀 LuckDB SDK 浏览器兼容性测试</h1>
        <p>测试 SDK 在浏览器环境中的 WebSocket 功能</p>
      </div>

      <div id="status" class="status info">准备就绪，点击"开始测试"按钮开始</div>

      <div class="controls">
        <button id="startTest" onclick="startTest()">开始测试</button>
        <button id="stopTest" onclick="stopTest()" disabled>停止测试</button>
        <button id="clearLog" onclick="clearLog()">清空日志</button>
      </div>

      <h3>📊 测试统计</h3>
      <div id="stats" class="status info">总事件数: 0 | 连接状态: 未连接 | 运行时间: 0s</div>

      <h3>📝 实时事件</h3>
      <div id="events" style="max-height: 300px; overflow-y: auto">
        <div class="status info">等待事件...</div>
      </div>

      <h3>📋 详细日志</h3>
      <div id="log" class="log">等待测试开始...</div>
    </div>

    <!-- 使用 CDN 加载 SDK -->
    <script type="module">
      // 模拟 SDK 导入（实际使用时需要从 npm 包导入）
      // import { LuckDB } from '@easyspace/luckdb-sdk';

      // 为了演示，我们创建一个模拟的 SDK 类
      class MockLuckDB {
        constructor(config) {
          this.config = config;
          this.ws = null;
          this.isConnected = false;
          this.eventListeners = {
            recordChange: [],
            collaboration: [],
            presenceUpdate: [],
            cursorUpdate: [],
            notification: [],
          };
        }

        async login(credentials) {
          this.log('正在登录...', 'info');
          // 模拟登录
          await new Promise((resolve) => setTimeout(resolve, 1000));
          this.log('登录成功', 'success');
          return {
            user: { id: 'browser_user', email: credentials.email },
            accessToken: 'mock_token_' + Date.now(),
            refreshToken: 'mock_refresh_' + Date.now(),
          };
        }

        connectWebSocket() {
          this.log('正在连接 WebSocket...', 'info');

          // 检查浏览器 WebSocket 支持
          if (!window.WebSocket) {
            throw new Error('浏览器不支持 WebSocket');
          }

          // 创建 WebSocket 连接
          const wsUrl = 'ws://localhost:8080/ws?token=mock_token&user_id=browser_user';
          this.ws = new WebSocket(wsUrl);

          this.ws.onopen = () => {
            this.isConnected = true;
            this.log('WebSocket 连接成功', 'success');
            this.updateStatus('WebSocket 连接成功', 'success');
            this.updateStats();
          };

          this.ws.onmessage = (event) => {
            try {
              const message = JSON.parse(event.data);
              this.log(`收到 WebSocket 消息: ${JSON.stringify(message, null, 2)}`, 'info');
              this.addEvent('WebSocket 消息', message);
              this.handleWebSocketMessage(message);
            } catch (e) {
              this.log(`解析 WebSocket 消息失败: ${e.message}`, 'error');
            }
          };

          this.ws.onclose = () => {
            this.isConnected = false;
            this.log('WebSocket 连接关闭', 'warning');
            this.updateStatus('WebSocket 连接关闭', 'error');
            this.updateStats();
          };

          this.ws.onerror = (error) => {
            this.log(`WebSocket 错误: ${error}`, 'error');
            this.updateStatus('WebSocket 连接错误', 'error');
          };
        }

        handleWebSocketMessage(message) {
          // 根据消息类型触发相应的事件监听器
          if (message.type === 'op') {
            this.eventListeners.recordChange.forEach((callback) => {
              callback(message);
            });
          }
        }

        onRecordChange(callback) {
          this.eventListeners.recordChange.push(callback);
          this.log('已注册记录变更监听器', 'info');
        }

        onCollaboration(callback) {
          this.eventListeners.collaboration.push(callback);
          this.log('已注册协作事件监听器', 'info');
        }

        onPresenceUpdate(callback) {
          this.eventListeners.presenceUpdate.push(callback);
          this.log('已注册在线状态监听器', 'info');
        }

        onCursorUpdate(callback) {
          this.eventListeners.cursorUpdate.push(callback);
          this.log('已注册光标更新监听器', 'info');
        }

        onNotification(callback) {
          this.eventListeners.notification.push(callback);
          this.log('已注册通知监听器', 'info');
        }

        subscribeToTable(tableId) {
          if (!this.isConnected) {
            throw new Error('WebSocket 未连接');
          }

          const message = {
            type: 'subscribe',
            collection: 'table',
            document: tableId,
            id: 'sub_' + Date.now() + '_table.' + tableId,
          };

          this.ws.send(JSON.stringify(message));
          this.log(`已订阅表格: ${tableId}`, 'success');
        }

        disconnectWebSocket() {
          if (this.ws) {
            this.ws.close();
            this.ws = null;
            this.isConnected = false;
            this.log('WebSocket 连接已断开', 'info');
          }
        }

        getWebSocketState() {
          if (!this.ws) return 'disconnected';
          switch (this.ws.readyState) {
            case WebSocket.CONNECTING:
              return 'connecting';
            case WebSocket.OPEN:
              return 'connected';
            case WebSocket.CLOSING:
              return 'closing';
            case WebSocket.CLOSED:
              return 'disconnected';
            default:
              return 'unknown';
          }
        }

        log(message, type = 'info') {
          const timestamp = new Date().toLocaleTimeString();
          const logElement = document.getElementById('log');
          const logEntry = `[${timestamp}] ${message}\n`;
          logElement.textContent += logEntry;
          logElement.scrollTop = logElement.scrollHeight;
        }

        addEvent(type, data) {
          const eventsContainer = document.getElementById('events');
          const eventElement = document.createElement('div');
          eventElement.className = 'event-item';
          eventElement.innerHTML = `
                    <div class="event-time">${new Date().toLocaleTimeString()}</div>
                    <div class="event-type">${type}</div>
                    <div>${JSON.stringify(data, null, 2)}</div>
                `;
          eventsContainer.insertBefore(eventElement, eventsContainer.firstChild);

          // 限制事件数量
          while (eventsContainer.children.length > 20) {
            eventsContainer.removeChild(eventsContainer.lastChild);
          }
        }

        updateStatus(message, type) {
          const statusElement = document.getElementById('status');
          statusElement.textContent = message;
          statusElement.className = `status ${type}`;
        }

        updateStats() {
          const statsElement = document.getElementById('stats');
          const eventCount = document.getElementById('events').children.length - 1; // 减去"等待事件..."提示
          const state = this.getWebSocketState();
          const runtime = Math.floor((Date.now() - this.startTime) / 1000);
          statsElement.textContent = `总事件数: ${eventCount} | 连接状态: ${state} | 运行时间: ${runtime}s`;
        }
      }

      // 全局变量
      let sdk = null;
      let testInterval = null;
      let eventCount = 0;

      // 测试函数
      window.startTest = async function () {
        try {
          document.getElementById('startTest').disabled = true;
          document.getElementById('stopTest').disabled = false;

          // 创建 SDK 实例
          sdk = new MockLuckDB({
            baseURL: 'http://localhost:8080',
            debug: true,
          });
          sdk.startTime = Date.now();

          // 设置事件监听器
          sdk.onRecordChange((message) => {
            eventCount++;
            sdk.log(`记录变更事件 #${eventCount}: ${JSON.stringify(message)}`, 'success');
          });

          sdk.onCollaboration((message) => {
            eventCount++;
            sdk.log(`协作事件 #${eventCount}: ${JSON.stringify(message)}`, 'info');
          });

          sdk.onPresenceUpdate((message) => {
            eventCount++;
            sdk.log(`在线状态更新 #${eventCount}: ${JSON.stringify(message)}`, 'info');
          });

          sdk.onCursorUpdate((message) => {
            eventCount++;
            sdk.log(`光标更新 #${eventCount}: ${JSON.stringify(message)}`, 'info');
          });

          sdk.onNotification((message) => {
            eventCount++;
            sdk.log(`通知事件 #${eventCount}: ${JSON.stringify(message)}`, 'info');
          });

          // 登录
          await sdk.login({ email: 'browser@test.com', password: 'test123' });

          // 连接 WebSocket
          sdk.connectWebSocket();

          // 等待连接建立
          await new Promise((resolve) => setTimeout(resolve, 2000));

          // 订阅表格
          sdk.subscribeToTable('tbl_test');

          // 开始定期更新统计
          testInterval = setInterval(() => {
            if (sdk) {
              sdk.updateStats();
            }
          }, 1000);

          sdk.log('浏览器兼容性测试已启动', 'success');
        } catch (error) {
          sdk.log(`测试启动失败: ${error.message}`, 'error');
          document.getElementById('startTest').disabled = false;
          document.getElementById('stopTest').disabled = true;
        }
      };

      window.stopTest = function () {
        if (sdk) {
          sdk.disconnectWebSocket();
          sdk = null;
        }

        if (testInterval) {
          clearInterval(testInterval);
          testInterval = null;
        }

        document.getElementById('startTest').disabled = false;
        document.getElementById('stopTest').disabled = true;

        const statusElement = document.getElementById('status');
        statusElement.textContent = '测试已停止';
        statusElement.className = 'status info';
      };

      window.clearLog = function () {
        document.getElementById('log').textContent = '';
        document.getElementById('events').innerHTML = '<div class="status info">等待事件...</div>';
        eventCount = 0;
      };

      // 页面加载完成后的初始化
      document.addEventListener('DOMContentLoaded', function () {
        const logElement = document.getElementById('log');
        logElement.textContent = '页面加载完成，准备开始测试...\n';

        // 检查浏览器兼容性
        const compatibility = {
          webSocket: !!window.WebSocket,
          json: !!window.JSON,
          promises: !!window.Promise,
          fetch: !!window.fetch,
        };

        let compatibilityStatus = '浏览器兼容性检查:\n';
        Object.entries(compatibility).forEach(([feature, supported]) => {
          compatibilityStatus += `  ${feature}: ${supported ? '✅ 支持' : '❌ 不支持'}\n`;
        });

        logElement.textContent += compatibilityStatus;
      });
    </script>
  </body>
</html>
