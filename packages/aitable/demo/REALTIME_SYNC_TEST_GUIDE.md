# 实时同步功能测试指南

## 概述

本指南将帮助你测试 LuckDB Demo 的实时同步功能。该功能允许多个页面之间实时同步表结构变更和数据变更。

## 功能特性

### ✅ 已实现的功能

1. **表结构实时同步**

   - 字段添加/删除/修改
   - 字段类型变更
   - 字段配置更新

2. **数据实时同步**

   - 记录添加/删除/更新
   - 字段值变更
   - 批量操作同步

3. **连接状态监控**

   - WebSocket 连接状态显示
   - 最后同步时间显示
   - 手动刷新功能

4. **自动刷新机制**
   - 10秒自动刷新间隔
   - 事件驱动的即时更新
   - 错误重试机制

## 测试步骤

### 1. 准备测试环境

```bash
# 确保后端服务正在运行
cd /Users/leven/space/easy/luckdb/server
./bin/luckdb serve

# 启动前端开发服务器
cd /Users/leven/space/easy/luckdb/packages/aitable/demo
npm run dev
```

### 2. 多标签页测试

#### 步骤 1: 打开多个标签页

1. 在浏览器中打开 `http://localhost:5175`
2. 登录系统（使用配置的测试账号）
3. 复制当前标签页，打开 2-3 个相同的页面
4. 确保所有标签页都显示"实时同步: 已连接"状态

#### 步骤 2: 测试表结构同步

**测试字段添加同步：**

1. 在标签页 A 中：

   - 点击"添加字段"按钮
   - 创建一个新字段（如：`测试字段_${Date.now()}`）
   - 选择字段类型（如：文本）
   - 确认创建

2. 观察标签页 B 和 C：
   - 应该自动显示新添加的字段
   - 状态栏显示"最后同步"时间更新
   - 无需手动刷新

**测试字段修改同步：**

1. 在标签页 B 中：

   - 右键点击刚创建的字段
   - 选择"编辑字段"
   - 修改字段名称或类型
   - 保存更改

2. 观察其他标签页：
   - 字段信息应该实时更新
   - 表格列标题显示新的字段名

#### 步骤 3: 测试数据同步

**测试记录添加同步：**

1. 在标签页 A 中：

   - 点击"添加记录"按钮
   - 填写记录数据
   - 保存记录

2. 观察其他标签页：
   - 新记录应该自动出现在表格中
   - 记录数量实时更新

**测试记录更新同步：**

1. 在标签页 B 中：

   - 点击任意单元格进行编辑
   - 修改字段值
   - 按 Enter 保存

2. 观察其他标签页：
   - 对应单元格的值应该实时更新
   - 显示最新的修改时间

**测试记录删除同步：**

1. 在标签页 C 中：

   - 右键点击任意记录行
   - 选择"删除记录"
   - 确认删除

2. 观察其他标签页：
   - 记录应该从表格中消失
   - 记录数量相应减少

### 3. 连接状态测试

#### 测试连接断开恢复：

1. 停止后端服务（模拟网络断开）
2. 观察前端状态：

   - 状态栏显示"实时同步: 已断开"
   - 手动刷新按钮变为可用状态

3. 重启后端服务
4. 观察前端状态：
   - 状态栏显示"实时同步: 已连接"
   - 自动恢复数据同步

#### 测试手动刷新：

1. 在连接断开状态下：
   - 点击"刷新数据"按钮
   - 观察数据是否成功刷新
   - 检查错误提示信息

### 4. 性能测试

#### 测试大量数据同步：

1. 批量添加 50+ 条记录
2. 观察同步性能：
   - 其他标签页的更新延迟
   - 浏览器性能表现
   - 内存使用情况

#### 测试并发操作：

1. 同时在多个标签页进行不同操作：
   - 标签页 A：添加字段
   - 标签页 B：添加记录
   - 标签页 C：修改记录
2. 观察冲突处理：
   - 操作是否都能成功
   - 数据一致性是否保持

## 预期结果

### ✅ 正常情况

- **即时同步**: 操作后 1-2 秒内其他页面更新
- **状态一致**: 所有页面显示相同的数据
- **连接稳定**: WebSocket 连接保持稳定
- **错误处理**: 网络问题时显示友好提示

### ❌ 异常情况处理

- **连接断开**: 显示断开状态，提供手动刷新
- **同步失败**: 显示错误信息，自动重试
- **数据冲突**: 使用乐观锁机制处理
- **性能问题**: 自动降级到轮询模式

## 调试信息

### 控制台日志

实时同步功能会在浏览器控制台输出详细的调试信息：

```javascript
// 连接状态
✅ WebSocket 已连接
✅ ShareDB 已连接

// 数据同步
🔄 获取字段列表...
✅ 字段列表更新: 5 个字段
🔄 获取记录列表...
✅ 记录列表更新: 10 条记录

// 事件监听
🆕 字段已创建: { fieldId: "fld_xxx", name: "新字段" }
🔄 记录已更新: { recordId: "rec_xxx", changes: {...} }
```

### 网络面板

在浏览器开发者工具的 Network 面板中：

1. **WebSocket 连接**: 查看 `ws://localhost:8080` 连接状态
2. **API 请求**: 监控数据刷新请求
3. **错误信息**: 查看失败的请求和错误响应

## 故障排除

### 常见问题

#### 1. 实时同步不工作

**可能原因：**

- WebSocket 连接失败
- 后端服务未启动
- 网络配置问题

**解决方法：**

```bash
# 检查后端服务
curl http://localhost:8080/health

# 检查 WebSocket 连接
# 在浏览器控制台执行：
const ws = new WebSocket('ws://localhost:8080');
ws.onopen = () => console.log('WebSocket 连接成功');
ws.onerror = (e) => console.error('WebSocket 连接失败', e);
```

#### 2. 数据不同步

**可能原因：**

- 事件监听器未正确设置
- 数据格式不匹配
- 缓存问题

**解决方法：**

- 检查控制台错误信息
- 手动点击"刷新数据"按钮
- 清除浏览器缓存重新测试

#### 3. 性能问题

**可能原因：**

- 数据量过大
- 频繁的同步请求
- 浏览器资源不足

**解决方法：**

- 减少自动刷新频率
- 优化数据查询
- 使用分页加载

## 技术实现

### 核心组件

1. **useRealtimeSync Hook**

   - 管理实时同步状态
   - 处理 WebSocket 事件
   - 提供刷新功能

2. **WebSocket 监听器**

   - 监听表结构变更事件
   - 监听数据变更事件
   - 处理连接状态变化

3. **自动刷新机制**
   - 定时刷新数据
   - 事件驱动更新
   - 错误重试逻辑

### 事件类型

```typescript
// 表结构事件
'table.field.created';
'table.field.updated';
'table.field.deleted';

// 数据事件
'record.created';
'record.updated';
'record.deleted';

// ShareDB 事件
'document.changed';
```

## 总结

实时同步功能为 LuckDB Demo 提供了强大的协作能力，支持多用户同时编辑和查看数据。通过 WebSocket 连接和事件驱动机制，实现了真正的实时数据同步。

### 主要优势

- ✅ **即时同步**: 操作后立即反映到所有页面
- ✅ **状态监控**: 实时显示连接和同步状态
- ✅ **错误处理**: 完善的错误处理和恢复机制
- ✅ **性能优化**: 智能的刷新策略和缓存机制

### 使用建议

- 在稳定的网络环境下测试
- 定期检查连接状态
- 遇到问题时查看控制台日志
- 使用手动刷新作为备用方案
