# Makefile for LuckDB Server

# ç‰ˆæœ¬ä¿¡æ¯
VERSION ?= 0.1.0
COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "dev")
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S')
LDFLAGS := -X main.Version=$(VERSION) -X main.GitCommit=$(COMMIT) -X main.BuildTime=$(BUILD_TIME)

.PHONY: help test test-unit test-integration test-coverage test-all clean build run

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "LuckDB Server - å¯ç”¨å‘½ä»¤ï¼š"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ==================== æ„å»ºå‘½ä»¤ ====================

build: ## æ„å»º LuckDB æœåŠ¡å™¨ï¼ˆå¼€å‘ç‰ˆæœ¬ï¼‰
	@echo "ğŸ”¨ æ„å»º LuckDB æœåŠ¡å™¨..."
	@mkdir -p bin
	go build -o bin/luckdb ./cmd/luckdb
	@echo "âœ… æ„å»ºå®Œæˆ: bin/luckdb"

build-prod: ## æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼‰
	@echo "ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
	@echo "   ç‰ˆæœ¬: $(VERSION)"
	@echo "   æäº¤: $(COMMIT)"
	@echo "   æ—¶é—´: $(BUILD_TIME)"
	@mkdir -p bin
	go build -ldflags="$(LDFLAGS)" -o bin/luckdb ./cmd/luckdb
	@echo "âœ… æ„å»ºå®Œæˆ: bin/luckdb"

build-linux: ## æ„å»º Linux ç‰ˆæœ¬
	@echo "ğŸ§ æ„å»º Linux ç‰ˆæœ¬..."
	@mkdir -p bin
	GOOS=linux GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/luckdb-linux ./cmd/luckdb
	@echo "âœ… Linux ç‰ˆæœ¬æ„å»ºå®Œæˆ: bin/luckdb-linux"

build-macos: ## æ„å»º macOS ç‰ˆæœ¬
	@echo "ğŸ æ„å»º macOS ç‰ˆæœ¬..."
	@mkdir -p bin
	GOOS=darwin GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/luckdb-darwin-amd64 ./cmd/luckdb
	GOOS=darwin GOARCH=arm64 go build -ldflags="$(LDFLAGS)" -o bin/luckdb-darwin-arm64 ./cmd/luckdb
	@echo "âœ… macOS ç‰ˆæœ¬æ„å»ºå®Œæˆ"

build-windows: ## æ„å»º Windows ç‰ˆæœ¬
	@echo "ğŸªŸ æ„å»º Windows ç‰ˆæœ¬..."
	@mkdir -p bin
	GOOS=windows GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/luckdb-windows.exe ./cmd/luckdb
	@echo "âœ… Windows ç‰ˆæœ¬æ„å»ºå®Œæˆ: bin/luckdb-windows.exe"

build-cross: build-linux build-macos build-windows ## äº¤å‰ç¼–è¯‘æ‰€æœ‰å¹³å°

install: build ## å®‰è£…åˆ° $GOPATH/bin
	@echo "ğŸ“¦ å®‰è£… LuckDB..."
	cp bin/luckdb $(GOPATH)/bin/luckdb
	@echo "âœ… å®‰è£…å®Œæˆ: $(GOPATH)/bin/luckdb"

clean: ## æ¸…ç†æ„å»ºæ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf bin/
	rm -f coverage.out coverage.html
	rm -rf coverage/
	go clean -testcache
	@echo "âœ… æ¸…ç†å®Œæˆ"

# ==================== è¿è¡Œå‘½ä»¤ ====================

run: ## è¿è¡Œ API æœåŠ¡å™¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
	@echo "ğŸš€ å¯åŠ¨ LuckDB API æœåŠ¡å™¨..."
	go run ./cmd/luckdb serve

dev: run ## åˆ«åï¼šè¿è¡Œ API æœåŠ¡å™¨

run-mcp: ## è¿è¡Œ MCP æœåŠ¡å™¨ï¼ˆHTTP æ¨¡å¼ï¼‰
	@echo "ğŸš€ å¯åŠ¨ MCP æœåŠ¡å™¨..."
	go run ./cmd/luckdb mcp serve --transport=http

run-mcp-stdio: ## è¿è¡Œ MCP æœåŠ¡å™¨ï¼ˆstdio æ¨¡å¼ï¼‰
	@echo "ğŸš€ å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆstdioï¼‰..."
	go run ./cmd/luckdb mcp serve --transport=stdio

# ==================== æ•°æ®åº“å‘½ä»¤ ====================

migrate: ## æ‰§è¡Œæ•°æ®åº“è¿ç§»
	@echo "ğŸ“Š æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	go run ./cmd/luckdb migrate up

migrate-up: migrate ## åˆ«åï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

migrate-down: ## å›æ»šæ•°æ®åº“è¿ç§»
	@echo "ğŸ“Š å›æ»šæ•°æ®åº“è¿ç§»..."
	go run ./cmd/luckdb migrate down

migrate-version: ## æ˜¾ç¤ºå½“å‰è¿ç§»ç‰ˆæœ¬
	@echo "ğŸ“Š æŸ¥çœ‹è¿ç§»ç‰ˆæœ¬..."
	go run ./cmd/luckdb migrate version

migrate-force: ## å¼ºåˆ¶è®¾ç½®è¿ç§»ç‰ˆæœ¬ï¼ˆéœ€è¦ VERSION å‚æ•°ï¼‰
	@echo "ğŸ“Š å¼ºåˆ¶è®¾ç½®è¿ç§»ç‰ˆæœ¬ $(VERSION)..."
	go run ./cmd/luckdb migrate force $(VERSION)

migrate-drop: ## åˆ é™¤æ‰€æœ‰è¡¨ï¼ˆå±é™©ï¼ï¼‰
	@echo "âš ï¸  åˆ é™¤æ‰€æœ‰è¡¨..."
	go run ./cmd/luckdb migrate drop

# ==================== å·¥å…·å‘½ä»¤ ====================

password: ## ç”Ÿæˆå¯†ç å“ˆå¸Œï¼ˆéœ€è¦ PWD å‚æ•°ï¼‰
	@echo "ğŸ”‘ ç”Ÿæˆå¯†ç å“ˆå¸Œ..."
	go run ./cmd/luckdb util generate-password --password $(PWD)

debug-config: ## è°ƒè¯•é…ç½®
	@echo "ğŸ” è°ƒè¯•é…ç½®..."
	go run ./cmd/luckdb util debug-config

# ==================== æµ‹è¯•å‘½ä»¤ ====================

test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•..."
	go test ./... -v -count=1

test-unit: ## è¿è¡Œå•å…ƒæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	go test ./internal/domain/... ./internal/application/... -v -count=1

test-integration: ## è¿è¡Œé›†æˆæµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	go test ./internal/testing/integration/... -v -count=1 -tags=integration

test-coverage: ## ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	go test ./... -coverprofile=coverage.out -covermode=atomic
	go tool cover -html=coverage.out -o coverage.html
	go tool cover -func=coverage.out | grep total
	@echo "ğŸ“ è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆï¼šcoverage.html"

test-coverage-detailed: ## ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆè¯¦ç»†æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	@mkdir -p coverage
	go test ./internal/domain/... -coverprofile=coverage/domain.out
	go test ./internal/application/... -coverprofile=coverage/application.out
	go test ./internal/infrastructure/... -coverprofile=coverage/infrastructure.out
	go test ./internal/interfaces/... -coverprofile=coverage/interfaces.out
	go test ./internal/commands/... -coverprofile=coverage/commands.out
	go test ./internal/mcp/... -coverprofile=coverage/mcp.out
	@echo "âœ… è¯¦ç»†æŠ¥å‘Šç”Ÿæˆåœ¨ coverage/ ç›®å½•"

test-domain: ## æµ‹è¯•é¢†åŸŸå±‚
	@echo "ğŸ§ª æµ‹è¯•é¢†åŸŸå±‚..."
	go test ./internal/domain/... -v -count=1

test-application: ## æµ‹è¯•åº”ç”¨å±‚
	@echo "ğŸ§ª æµ‹è¯•åº”ç”¨å±‚..."
	go test ./internal/application/... -v -count=1

test-infrastructure: ## æµ‹è¯•åŸºç¡€è®¾æ–½å±‚
	@echo "ğŸ§ª æµ‹è¯•åŸºç¡€è®¾æ–½å±‚..."
	go test ./internal/infrastructure/... -v -count=1

test-interfaces: ## æµ‹è¯•æ¥å£å±‚
	@echo "ğŸ§ª æµ‹è¯•æ¥å£å±‚..."
	go test ./internal/interfaces/... -v -count=1

test-mcp: ## æµ‹è¯• MCP æ¨¡å—
	@echo "ğŸ§ª æµ‹è¯• MCP æ¨¡å—..."
	go test ./internal/mcp/... -v -count=1

test-bench: ## è¿è¡Œæ€§èƒ½æµ‹è¯•
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	go test ./... -bench=. -benchmem -run=^Benchmark

test-race: ## è¿è¡Œç«æ€æ£€æµ‹
	@echo "ğŸ” è¿è¡Œç«æ€æ£€æµ‹..."
	go test ./... -race -count=1

test-short: ## è¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼ˆè·³è¿‡æ…¢é€Ÿæµ‹è¯•ï¼‰
	@echo "âš¡ è¿è¡Œå¿«é€Ÿæµ‹è¯•..."
	go test ./... -short -count=1

test-all: test test-coverage ## è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

# ==================== ä»£ç è´¨é‡å‘½ä»¤ ====================

lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	golangci-lint run ./...

fmt: ## æ ¼å¼åŒ–ä»£ç 
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...
	goimports -w .

vet: ## è¿è¡Œä»£ç å®¡æŸ¥
	@echo "ğŸ” è¿è¡Œä»£ç å®¡æŸ¥..."
	go vet ./...

# ==================== ä¾èµ–ç®¡ç† ====================

deps: ## å®‰è£…ä¾èµ–
	@echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
	go mod download
	go mod tidy

deps-update: ## æ›´æ–°ä¾èµ–
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
	go get -u ./...
	go mod tidy

deps-check: ## æ£€æŸ¥ä¾èµ–æ›´æ–°
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–æ›´æ–°..."
	go list -u -m all

# ==================== Docker å‘½ä»¤ ====================

docker-build: ## æ„å»º Docker é•œåƒ
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build -t luckdb:$(VERSION) -t luckdb:latest -f ../docker/Dockerfile.server ..

docker-run: ## è¿è¡Œ Docker å®¹å™¨
	@echo "ğŸ³ è¿è¡Œ Docker å®¹å™¨..."
	docker run -p 8080:8080 luckdb:latest

docker-push: ## æ¨é€ Docker é•œåƒ
	@echo "ğŸ³ æ¨é€ Docker é•œåƒ..."
	docker push luckdb:$(VERSION)
	docker push luckdb:latest

# ==================== å¿«é€Ÿå¯åŠ¨å‘½ä»¤ ====================

start: build ## ç¼–è¯‘å¹¶å¯åŠ¨æœåŠ¡å™¨
	@echo "ğŸš€ å¯åŠ¨ LuckDB..."
	./bin/luckdb serve

stop: ## åœæ­¢æ‰€æœ‰ LuckDB è¿›ç¨‹
	@echo "ğŸ›‘ åœæ­¢ LuckDB..."
	@pkill -f "luckdb" || true

restart: stop start ## é‡å¯æœåŠ¡å™¨

# ==================== å®Œæ•´æµ‹è¯•æµç¨‹ ====================

full-test: clean deps build migrate test ## å®Œæ•´æµ‹è¯•æµç¨‹ï¼ˆæ¸…ç†+ä¾èµ–+æ„å»º+è¿ç§»+æµ‹è¯•ï¼‰

ci: deps build test lint ## CI æµç¨‹ï¼ˆä¾èµ–+æ„å»º+æµ‹è¯•+æ£€æŸ¥ï¼‰

# ==================== ç‰ˆæœ¬ä¿¡æ¯ ====================

version: ## æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
	@echo "ğŸ“¦ LuckDB ç‰ˆæœ¬ä¿¡æ¯:"
	@echo "  ç‰ˆæœ¬: $(VERSION)"
	@echo "  æäº¤: $(COMMIT)"
	@echo "  æ„å»ºæ—¶é—´: $(BUILD_TIME)"

.DEFAULT_GOAL := help
